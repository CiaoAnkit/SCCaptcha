<!DOCTYPE html>
<html lang="en">

<head>
	<meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.7.45">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
	<!-- <link rel="stylesheet" href="./gyro-task1.css"> -->
	<title>ReCap task 1</title>
</head>

<body>
	<div id="gameContainer">
		<div id="ball"></div>
		<div id="imgs">
			<img id="img1" src="pics/{{this}}.png" alt="arrow" width="50px" height="50px"
				style="position: absolute; left: {{ x }}px; top: {{ y }}px;">
			<img id="img2" src="pics/{{this}}.png" alt="arrow" width="50px" height="50px" class="rotate90">
			<img id="img3" src="pics/{{this}}.png" alt="arrow" width="50px" height="50px" class="rotate180">
			<img id="img4" src="pics/{{this}}.png" alt="arrow" width="50px" height="50px" class="rotate270">
		</div>
	</div>
	<script>
		let squares = document.getElementById("imgs").children
		let captchaBox = [];
		const ball = document.querySelector("#ball");
		const gameContainer = document.querySelector("#gameContainer");

		let accx = 0;
		let accy = 0;
		const squareSize = 20;
		const tlimit = 20;
		let margin = 10;
		let time = 0
		// let squares = document.getElementById("imgs").children
		// let captchaBox = []
		// let captchaDone = false
		let captchaid = 0
		let inSquare = [false, false, false, false]

		if ('Accelerometer' in window) {
			const acc = new Accelerometer({frequency: 60});
			acc.start();
			acc.addEventListener('reading', async function moveBall(e) {
				accx = acc.x;
				accy = acc.y;
				// console.log(x, y)
				let ballLeft = ball.offsetLeft - accx * 5;
				let ballTop = ball.offsetTop + accy * 5;
				let f = false;
				if (ballLeft <= 0 || ballLeft + ball.offsetWidth >= gameContainer.offsetWidth) {
					if ((ballTop <= 0 || ballTop + ball.offsetHeight >= gameContainer.offsetHeight) && !f) {
						return;
					}
					ball.style.top = ballTop + "px";
					f = true;

				}
				else if ((ballTop <= 0 || ballTop + ball.offsetHeight >= gameContainer.offsetHeight) && !f) {
					if (ballLeft <= 0 || ballLeft + ball.offsetWidth >= gameContainer.offsetWidth) {
						return;
					}
					ball.style.left = ballLeft + "px";
					f = true;
				}

				if (!f) {
					ball.style.left = ballLeft + "px";
					ball.style.top = ballTop + "px";
				}
			});
		} else {
			console.error('Accelerometer not supported');
		}

		function responseHandler(data) {
			console.log(data);
			if (data['bool'] == "true") {

				alert("Captcha passed")
				clearInterval(captchaid)
				location.href = "https://iiit.ac.in"
			}

			else {
				// alert("Captcha failed, try again")
				if (confirm("Captcha failed, try again")) {
					clearInterval(captchaid)
					location.reload();
				}
			}


		}

		function checkSquare() {
			let square;
			let margin = squareSize;
			for (let i = 0; i < 4; i++) {
				if (inSquare[i] == true) {
					// console.log(i)
					if ((ball.style.left < captchaBox[i].right) && (ball.style.left > captchaBox[i].left)) {
						if ((ball.style.top < captchaBox[i].bottom) && (ball.style.top > captchaBox[i].top)) {
							time += 1;
						}
						else {
							time = 0;
							inSquare[i] = false;
						}
					}
					else {
						time = 0;
						inSquare[i] = false;
					}

					if (time > tlimit) {
						const requestOptions = {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({guess: i})
						};
						fetch("guess", requestOptions)
							.then(response => response.json())
							.then(data => responseHandler(data))
							.catch(error => console.error('Error:', error));

					}
				}
				else if ((ball.style.left < captchaBox[i].right) && (ball.style.left > captchaBox[i].left)) {
					if ((ball.style.top < captchaBox[i].bottom) && (ball.style.top > captchaBox[i].top)) {
						inSquare[i] = true
						time = 0
					}
				}

			}
		}



		//place rotated images
		// for (let i = 0; i < 4; i++) {
		// 	let square = squares[i];
		// 	// square.style.width = squareSize + "px";
		// 	// square.style.height = squareSize + "px";
		// 	square.style.position = "absolute";
		// 	square.style.left = Math.floor(Math.random() * (gameContainer.offsetWidth - 2*squareSize)) + "px";
		// 	square.style.top = Math.floor(Math.random() * (gameContainer.offsetHeight - 2*squareSize)) + "px";
		// 	let areaBox = {
		// 		'left': (parseInt(square.style.left.replace(/px/,""))-margin)+"px",
		// 		'right': (parseInt(square.style.left.replace(/px/,""))+squareSize+margin)+"px",
		// 		'top': (parseInt(square.style.top.replace(/px/,""))-margin)+"px",
		// 		'bottom': (parseInt(square.style.top.replace(/px/,""))+squareSize+margin)+"px"
		// 	}
		// 	console.log(areaBox)
		// 	captchaBox.push(areaBox)
		// }
		////place rotated images
		box_pos = {{box_pos | tojson}};
		for (let i = 0; i < 4; i++) {
			let square = squares[i];
			// square.style.width = squareSize + "px";
			// square.style.height = squareSize + "px";
			square.style.position = "absolute";
			square.style.left = Math.floor(box_pos[i][0] * (gameContainer.offsetWidth - 2 * squareSize)) + "px";
			square.style.top = Math.floor(box_pos[i][1] * (gameContainer.offsetHeight - 2 * squareSize)) + "px";
			// square.style.left = (box_pos[i][0] * (gameContainer.offsetWidth - 2 * squareSize)) + "px";
			// square.style.top = (box_pos[i][1] * (gameContainer.offsetHeight - 2 * squareSize)) + "px";
			let areaBox = {
				'left': (parseInt(square.style.left.replace(/px/, "")) - margin) + "px",
				'right': (parseInt(square.style.left.replace(/px/, "")) + squareSize + margin) + "px",
				'top': (parseInt(square.style.top.replace(/px/, "")) - margin) + "px",
				'bottom': (parseInt(square.style.top.replace(/px/, "")) + squareSize + margin) + "px"
			}
			console.log(areaBox)
			captchaBox.push(areaBox)
		}

		captchaid = setInterval(checkSquare, 16);
		setTimeout(function () {
			location.reload();
		}, 10000);

	</script>

	<!-- <script src="{{ url_for('static', filename='js/index.js') }}"></script> -->
</body>

</html>
